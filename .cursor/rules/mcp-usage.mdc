# Правила эффективного использования MCP серверов для MB-migration

## Общие принципы

При работе с проектом MB-migration используй доступные MCP серверы для максимальной эффективности. Проект представляет собой PHP-библиотеку для миграции проектов из Ministry Brands в Brizy с модульной архитектурой (614+ PHP файлов).

### Критически важно: Базы данных
- **dbhub-migration** (MySQL): ЕДИНСТВЕННАЯ база для записи данных
  - Хост: `mb-migration.cupzc9ey0cip.us-east-1.rds.amazonaws.com`
  - База: `MG_prepare_mapping`
  - Используй ТОЛЬКО для записи данных миграций
- **dbhub-client-readonly** (PostgreSQL/MySQL): ТОЛЬКО для чтения
  - Хост: `ec2-54-226-97-109.compute-1.amazonaws.com`
  - Используй для чтения исходных данных из Ministry Brands
  - НИКОГДА не пытайся писать в эту базу

---

## 1. Serena (Семантический анализ PHP кода)

**Когда использовать:**
- Поиск PHP классов, методов, функций по имени или паттерну
- Навигация по коду в пространстве имен `MBMigration`
- Понимание структуры компонентов (Bridge, Builder, Layer, Core)
- Поиск всех использований символа в PHP коде
- Точечное редактирование PHP кода (замена тела метода, вставка после класса)
- Получение обзора PHP файла перед детальным чтением

**Инструменты:**
- `mcp_serena_find_symbol` - поиск классов/методов (например, `MBMigration/Core/Config`, `MBMigration/Bridge/Bridge`)
- `mcp_serena_get_symbols_overview` - обзор структуры PHP файла
- `mcp_serena_find_referencing_symbols` - поиск всех использований символа
- `mcp_serena_replace_symbol_body` - замена тела метода/функции
- `mcp_serena_read_file` - чтение PHP файлов (предпочтительнее обычного read_file)

**Специфика MB-migration:**
- Пространство имен: `MBMigration`
- Основные компоненты:
  - `MBMigration/Core/*` - Config, Logger, Utils, ErrorDump, S3Uploader
  - `MBMigration/Bridge/*` - Bridge.php (36KB), CloningManager, MigrationWaveManager
  - `MBMigration/Builder/*` - BrizyComponent, Layout/Theme (13 тем), Fonts, Media
  - `MBMigration/Layer/*` - Brizy API, MB API, DataSource, HTTP
  - `MBMigration/Browser/*` - Chrome автоматизация
  - `MBMigration/Parser/*` - JavaScript парсинг

**Правило:** Всегда используй Serena для навигации по PHP коду вместо grep, если он доступен. Особенно эффективно для работы с классами в пространстве имен `MBMigration`.

**Примеры:**
```
"Найди через serena класс MigrationPlatform"
"Покажи через serena все использования Bridge.php"
"Используя serena, найди все методы, которые вызывают Brizy API"
```

---

## 2. Ripgrep (Быстрый текстовый поиск)

**Когда использовать:**
- Поиск точных строк или паттернов в PHP файлах (614+ файлов)
- Поиск в конфигурационных файлах (.env, composer.json, package.json)
- Поиск в JavaScript/TypeScript файлах (dashboard/frontend, темы)
- Подсчет вхождений паттерна (например, количество использований класса)
- Поиск с фильтрацией по типам файлов (*.php, *.js, *.ts, *.json)
- Поиск в скрытых файлах или специфических директориях

**Инструменты:**
- `mcp_ripgrep_search` - базовый поиск
- `mcp_ripgrep_advanced-search` - поиск с фильтрами (fileType: php, js, ts)
- `mcp_ripgrep_count-matches` - подсчет совпадений
- `mcp_ripgrep_list-files` - список файлов по паттерну

**Специфика MB-migration:**
- Основные директории для поиска:
  - `lib/MBMigration/**/*.php` - PHP код библиотеки
  - `dashboard/api/**/*.php` - Dashboard API
  - `dashboard/frontend/src/**/*.{ts,tsx,js,jsx}` - React фронтенд
  - `lib/MBMigration/Builder/Layout/Theme/*/Assets/**/*.{ts,js,scss}` - Тематические ассеты
  - `public/**/*.php` - Entry points

**Правило:** Используй Ripgrep для текстового поиска, когда не нужен семантический анализ. Особенно эффективно для поиска по всем 13 темам одновременно.

**Примеры:**
```
"Найди через ripgrep все использования 'Brizy API' в PHP файлах"
"Подсчитай через ripgrep количество упоминаний 'MigrationPlatform'"
"Найди через ripgrep все файлы с 'Config' в названии"
```

---

## 3. Базы данных

### 3.1. dbhub-migration (MySQL, полный доступ)

**Когда использовать:**
- Запись данных о миграциях (ЕДИНСТВЕННАЯ база для записи!)
- Создание и обновление таблиц миграций
- Анализ структуры базы миграций
- Запросы для отладки процесса миграции
- Работа с таблицами: `migrations_mapping`, `migration_result_list`, `waves`

**Инструменты:**
- `mcp_dbhub-migration_execute_sql` - выполнение SQL (SELECT, INSERT, UPDATE, CREATE)
- `mcp_dbhub-migration_search_objects` - поиск таблиц, колонок, индексов

**Критически важно:**
- Хост: `mb-migration.cupzc9ey0cip.us-east-1.rds.amazonaws.com`
- База: `MG_prepare_mapping`
- Это ЕДИНСТВЕННАЯ база, куда можно писать!

**Примеры:**
```
"Покажи через dbhub-migration структуру таблицы migrations_mapping"
"Сколько проектов находится в процессе миграции?"
"Создай через dbhub-migration таблицу для хранения статусов"
"Найди через dbhub-migration все миграции с ошибками"
```

### 3.2. dbhub-client-readonly (PostgreSQL/MySQL, только чтение)

**Когда использовать:**
- Чтение исходных данных из Ministry Brands
- Изучение структуры клиентской базы
- Поиск данных для миграции
- Валидация данных перед миграцией
- Анализ исходных проектов, страниц, компонентов

**Инструменты:**
- `mcp_dbhub-client-readonly_execute_sql` - выполнение SQL (только SELECT!)
- `mcp_dbhub-client-readonly_search_objects` - поиск таблиц, колонок

**Критически важно:**
- Хост: `ec2-54-226-97-109.compute-1.amazonaws.com`
- ТОЛЬКО для чтения! НИКОГДА не пытайся писать!
- Переменные окружения загружаются из `.env` или `.env.prod.local`

**Примеры:**
```
"Покажи через dbhub-client-readonly структуру таблиц"
"Найди через dbhub-client-readonly все проекты пользователя X"
"Какие темы используются в проектах?"
"Покажи через dbhub-client-readonly примеры данных из таблицы pages"
```

**Правило:** 
- Для записи данных используй ТОЛЬКО `dbhub-migration`
- Для чтения клиентских данных используй `dbhub-client-readonly`
- НИКОГДА не пытайся писать в `dbhub-client-readonly`

---

## 4. Playwright (Автоматизация браузера)

**Когда использовать:**
- Тестирование миграций в реальном браузере
- Скриншоты страниц до/после миграции
- Проверка корректности отображения компонентов Brizy
- Автоматизация рутинных задач в браузере
- E2E тестирование Dashboard
- Визуальная проверка результатов миграции

**Инструменты:**
- `mcp_playwright_browser_navigate` - навигация по URL
- `mcp_playwright_browser_click` - клики по элементам
- `mcp_playwright_browser_snapshot` - снимок доступности страницы
- `mcp_playwright_browser_take_screenshot` - скриншот страницы
- `mcp_playwright_browser_fill_form` - заполнение форм

**Специфика MB-migration:**
- Entry points:
  - `http://localhost:8080/?mb_project_uuid=...&brz_project_id=...` - Main API
  - `http://localhost:8080/dashboard/api/*` - Dashboard API
  - `http://localhost:8080/dashboard` - Dashboard UI
- Используй для проверки визуального результата миграции

**Правило:** Используй для тестирования и визуальной проверки результатов миграции.

**Примеры:**
```
"Открой через playwright страницу миграции и сделай скриншот"
"Проверь через playwright, что все компоненты Brizy отображаются корректно"
"Протестируй через playwright процесс миграции в браузере"
```

---

## 5. GitMCP (Контекст репозитория)

### 5.1. gitmcp-mb-migration

**Когда использовать:**
- Получение документации из репозитория MB-migration
- Поиск информации в README, документации проекта
- Понимание структуры проекта через документацию
- Изучение примеров использования API
- Поиск информации о миграциях, темах, компонентах

**Инструменты:**
- `mcp_gitmcp-mb-migration_fetch_MB_migration_documentation` - полная документация
- `mcp_gitmcp-mb-migration_search_MB_migration_documentation` - поиск в документации
- `mcp_gitmcp-mb-migration_search_MB_migration_code` - поиск кода в репозитории

**Примеры:**
```
"Покажи через gitmcp-mb-migration документацию по настройке миграций"
"Как работает процесс миграции тем?"
"Какие есть примеры использования API?"
```

### 5.2. gitmcp-migration-hub

**Когда использовать:**
- Получение документации из репозитория migration-hub
- Понимание общей архитектуры системы миграций
- Изучение связанных проектов и инструментов

**Инструменты:**
- `mcp_gitmcp-migration-hub_fetch_migration_hub_documentation` - полная документация
- `mcp_gitmcp-migration-hub_search_migration_hub_docs` - поиск в документации
- `mcp_gitmcp-migration-hub_search_migration_hub_code` - поиск кода

**Правило:** Используй GitMCP для получения контекста проекта из документации GitHub репозиториев.

---

## Приоритеты использования

### 1. Навигация по PHP коду:
- **Сначала:** Serena (`find_symbol`, `get_symbols_overview`) - для семантического поиска
- **Если недоступен:** Ripgrep с фильтром `fileType: php`
- **Для быстрого текстового поиска:** Ripgrep

### 2. Поиск текста:
- **Сначала:** Ripgrep (быстрее для 614+ PHP файлов)
- **Если нужен семантический контекст:** Serena
- **Для поиска по темам:** Ripgrep с фильтром по директории `lib/MBMigration/Builder/Layout/Theme/`

### 3. Работа с БД:
- **Запись:** ТОЛЬКО `dbhub-migration` (MySQL, mb-migration.cupzc9ey0cip...)
- **Чтение клиентских данных:** `dbhub-client-readonly` (PostgreSQL/MySQL, ec2-54-226-97-109...)
- **НИКОГДА не пиши в dbhub-client-readonly!**

### 4. Документация:
- **Локальная документация:** GitMCP для получения контекста из GitHub
- **Локальные файлы:** `docs/`, `analysis/`, `.aiassistant/rules/` для детальной информации

### 5. Тестирование:
- **E2E тесты:** Playwright для браузерной автоматизации
- **PHPUnit тесты:** Обычные файлы в `tests/`

---

## Оптимизация производительности

### Для PHP проекта (614+ файлов):
- Используй `get_symbols_overview` перед детальным чтением PHP файла
- Используй `count-matches` перед полным поиском, если нужно только количество
- Используй фильтры в Ripgrep для ограничения области поиска:
  - `fileType: php` - только PHP файлы
  - `path: lib/MBMigration/Builder/Layout/Theme/` - только темы
  - `path: dashboard/api/` - только Dashboard API
- Используй `find_referencing_symbols` вместо поиска всех использований вручную
- Для поиска по всем 13 темам используй Ripgrep с фильтром по директории

### Для работы с базами данных:
- Используй `search_objects` перед выполнением SQL для понимания структуры
- Для чтения больших объемов данных используй LIMIT в SQL запросах
- Кэшируй результаты поиска объектов БД

---

## Комбинирование инструментов

### Пример 1: Добавление новой темы миграции
1. **serena** - Изучить структуру существующих тем
   ```
   "Покажи через serena структуру класса Theme для темы Anthem"
   ```
2. **ripgrep** - Найти все места, где используются темы
   ```
   "Найди через ripgrep все файлы, которые работают с темами"
   ```
3. **dbhub-migration** - Проверить структуру БД для хранения данных темы
   ```
   "Покажи через dbhub-migration таблицы, связанные с темами"
   ```
4. **gitmcp-mb-migration** - Изучить документацию по темам
   ```
   "Покажи через gitmcp-mb-migration документацию по добавлению новых тем"
   ```

### Пример 2: Отладка проблемы миграции
1. **dbhub-client-readonly** - Изучить исходные данные
   ```
   "Покажи через dbhub-client-readonly данные проекта X"
   ```
2. **ripgrep** - Найти код, обрабатывающий эти данные
   ```
   "Найди через ripgrep код, который обрабатывает проекты"
   ```
3. **serena** - Понять логику обработки
   ```
   "Покажи через serena метод, который мигрирует проекты"
   ```
4. **dbhub-migration** - Проверить, что записалось в БД
   ```
   "Покажи через dbhub-migration статус миграции проекта X"
   ```
5. **playwright** - Визуально проверить результат
   ```
   "Открой через playwright страницу миграции и сделай скриншот"
   ```

### Пример 3: Рефакторинг PHP кода
1. **serena** - Найти все использования кода
   ```
   "Найди через serena все места, где используется класс X"
   ```
2. **serena** - Переименовать или переместить код
   ```
   "Переименуй через serena метод oldMethod в newMethod"
   ```
3. **ripgrep** - Проверить, что ничего не пропущено
   ```
   "Найди через ripgrep все упоминания oldMethod"
   ```

### Пример 4: Анализ производительности миграций
1. **ripgrep** - Найти все вызовы API
   ```
   "Найди через ripgrep все вызовы Brizy API"
   ```
2. **serena** - Понять структуру вызовов
   ```
   "Покажи через serena все методы, которые делают HTTP запросы"
   ```
3. **dbhub-migration** - Проанализировать данные о производительности
   ```
   "Покажи через dbhub-migration статистику по времени миграций"
   ```

---

## Специфичные паттерны для MB-migration

### Работа с темами (13 тем)
- Используй Ripgrep для поиска по всем темам:
  ```
  "Найди через ripgrep все использования 'section' в темах"
  ```
- Используй Serena для навигации по структуре конкретной темы:
  ```
  "Покажи через serena структуру темы Boulevard"
  ```

### Работа с компонентами Brizy
- Используй Serena для поиска компонентов:
  ```
  "Найди через serena все классы BrizyComponent"
  ```
- Используй Ripgrep для поиска использований:
  ```
  "Найди через ripgrep все создания BrizyImageComponent"
  ```

### Работа с Bridge (36KB файл)
- Используй Serena для навигации по большому файлу:
  ```
  "Покажи через serena обзор Bridge.php"
  ```
- Используй Ripgrep для поиска конкретных методов:
  ```
  "Найди через ripgrep метод 'migrate' в Bridge.php"
  ```

### Работа с Dashboard
- Используй Ripgrep для поиска в React коде:
  ```
  "Найди через ripgrep компонент MigrationList в dashboard/frontend"
  ```
- Используй Playwright для тестирования UI:
  ```
  "Открой через playwright dashboard и проверь список миграций"
  ```

---

## Критические правила безопасности

1. **Базы данных:**
   - ✅ Запись ТОЛЬКО в `dbhub-migration` (mb-migration.cupzc9ey0cip...)
   - ❌ НИКОГДА не пиши в `dbhub-client-readonly`
   - ✅ Всегда проверяй хост перед записью

2. **Переменные окружения:**
   - Используй `.env` или `.env.prod.local` для `dbhub-client-readonly`
   - Не коммить чувствительные данные

3. **Тестирование:**
   - Используй Playwright для проверки перед продакшн деплоем
   - Проверяй результаты миграций визуально

---

## Чеклист эффективности

Перед началом работы:
- [ ] Определи, нужен ли семантический поиск (Serena) или текстовый (Ripgrep)
- [ ] Определи, нужна ли запись в БД (dbhub-migration) или только чтение
- [ ] Для больших файлов используй `get_symbols_overview` перед чтением
- [ ] Для поиска по темам используй фильтры Ripgrep
- [ ] Для визуальной проверки используй Playwright

---

**Готово!** Эти правила адаптированы специально для проекта MB-migration с учетом его PHP архитектуры, модульной структуры и специфики работы с миграциями.
